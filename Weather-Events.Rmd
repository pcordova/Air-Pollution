---
title: "Harmful Weather Events in the U.S. (1950-2011)"
author: "Pedro Córdova"
date: "`r Sys.Date()`"
output: html_document
---

## Synopsis

## Data Processing

#### Reading Data

First, let's do some "administrative", but necessary, preparation work.

We are going to do some configuration, download and sub-setting data file, load required libraries, etc.
```{r}
options(scipen=999) ## Turn off scientific notation globally

## Load required libraries
library(knitr)
library(data.table)
library(DT)
library(ggplot2)
#library(mapproj)
library(fiftystater)

## Download data file
if(!dir.exists("Data")) {dir.create("Data")} ## Create directory to store the file

if(!file.exists("./Data/stormData.csv.bz2")) {
    download.file("https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2",
                  "./Data/stormData.csv.bz2", method = "curl")
}

## Read data file
stormData <- fread("./Data/stormData.csv.bz2",
                               select = c(7,8,23:28),        ## Select just relevant columns
                               col.names = c("state",        ## Rename columns
                                             "event",
                                             "fatalities",
                                             "injuries",
                                             "propDamage",
                                             "propUnits",
                                             "cropDamage",
                                             "cropUnits"))
```
<br>
Now, we have the relevant data loaded into our workspace. 
How its structure looks like?
```{r}
str(stormData)
```
<br>

#### Cleaning Data

What about data integrity/quality?  
Let's check for `NA` values:
```{r}
cat("There exists", sum(is.na(stormData)),"NA values")
```
Nice!  

<br>
Time to take a look at relevant data to evaluate material losses.

As reported in [this file]("https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf") from the **National Weather Service Storm Data Documentation**:  

> _Alphabetical characters used to signify magnitude include “K” for thousands, “M” for millions, and “B” for billions._

Those characters are contained in `propUnits` and `cropUnits` columns. Let's see what there is inside:
```{r}
unique(stormData$propUnits)
unique(stormData$cropUnits)
```
As we can see, there is a lot of garbage that does not correspond to the required characters. Furthermore, we need the characters to be translated into numerical values in order to calculate the amount of material loss (e.g. `propDamage` values multiplied by `propUnits` values)

To start, let's assume that lower case `b`, `m` and `k` where introduced instead of its upper case counterparts.
<br>
<br>
First, let's create two columns filled with zeroes as a future containers for our units (B, M, K) as numeric values (1e+9, 1e+6, 1e+3):
```{r}
stormData[, `:=`(pUnits = 0, cUnits = 0)]
```
<br>
Second, let's translate characters to numeric values and assign them to their corresponding positions in the recently created columns:
```{r}
stormData[propUnits %in% c("K","k"), "pUnits" := 1e+3
          ][propUnits %in% c("M","m"), "pUnits" := 1e+6
            ][propUnits %in% c("B","b"), "pUnits" := 1e+9]

stormData[cropUnits %in% c("K","k"), "cUnits" := 1e+3
          ][cropUnits %in% c("M","m"), "cUnits" := 1e+6
            ][cropUnits %in% c("B","b"), "cUnits" := 1e+9]
```
Now we are ready to do the math!

We are going to calculate the monetary value of property and crop losses and tabulate the data:
```{r}
stormData[, `:=`(propLoss = propDamage*pUnits, cropLoss = cropDamage*cUnits)]
```

```{r}
cost <- stormData[, .(fatalities = sum(fatalities),
                      injuries = sum(injuries),
                      propLoss = sum(propLoss),
                      cropLoss = sum(cropLoss)),
                      by = event
                  ]

cost <- cost[fatalities != 0 | injuries != 0 | propLoss != 0 | cropLoss != 0]

cost[order(-fatalities,-injuries,-propLoss,-cropLoss)] %>% 
     datatable(colnames = c('Property Loss' = 4, 'Crop Loss' = 5),
              caption = "Table: Total Weather Events in the U.S., from Deadliest to less Harmful (1950-2011)",
              rownames = FALSE,
              options = list(dom = 'ftp')) %>%
     formatCurrency(c(4, 5), digits = 0)


```


# Results

Most harmful events to population health:
```{r}
cat("Deadliest weather event:", paste0(cost[which.max(cost$fatalities),event],"."),
    "\nIt accounts for",cost[,max(fatalities)],"fatalities between 1950 and 2011.")

cat("Weather event causing more injuries in the same period (1950-2011):",
    paste0(cost[which.max(cost$injuries),event],"."), "\nIt accounts for",
    cost[,max(injuries)], "injuries.")
```

```{r}
if(!file.exists("./Data/stormData.csv.bz2")) {
    download.file("https://raw.githubusercontent.com/pcordova/Weather-Events/main/statesCoord.csv",
              "./Data/statesCoord.csv", method = "curl")
}

states <- fread("./Data/statesCoord.csv", col.names = c("state","location","lat","lon"))

dang <- stormData[, .(fatalities = sum(fatalities),
                      injuries = sum(injuries),
                      propLoss = sum(propLoss),
                      cropLoss = sum(cropLoss)),
                      by = state
                  ]
mapdata <- dang[state %in% states$state]

setorder(mapdata,state)
setorder(states,state)

mapdata <- cbind(mapdata,states[,.(location,lat,lon)])
mapdata[,`:=` (location = tolower(location))]
```

```{r}

ggplot() + geom_polygon(data=fifty_states, aes(x=long, y=lat, group = group),color="white", fill="grey92" ) + 
  geom_point(data=mapdata, aes(x=lon, y=lat, size = fatalities), color="blue") + 
  scale_size(name="", range = c(2, 20)) + 
  guides(size=guide_legend("Fatalities 1950-2011")) +
  theme_void()
```

